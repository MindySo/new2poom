/*
 * Jenkins Pipeline - Frontend (S3 + CloudFront)
 * Triggers: Changes in frontend/ directory on dev branch
 */
pipeline {
    agent none

    environment {
        S3_PROD_BUCKET = 'topoom-prod-s3-bucket'
        S3_REGION = 'ap-southeast-2'
        CLOUDFRONT_DISTRIBUTION_ID = 'E2RFJP5707A0DX'
        CLOUDFRONT_REGION = 'us-east-1'
        HOME = '/tmp'
    }

    options {
        skipDefaultCheckout(true)
        skipStagesAfterUnstable()
        timestamps()
    }

    stages {

        /* -------------------------------------------------- */
        stage('Checkout') {
            agent any
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/dev']],
                    userRemoteConfigs: [[
                        url: 'https://lab.ssafy.com/s13-final/S13P31A706',
                        credentialsId: 'gitlab-jenkins-token'
                    ]],
                    extensions: [[$class: 'CloneOption', noTags: false, shallow: false, depth: 0]]
                ])
            }
        }

        /* -------------------------------------------------- */
        stage('Check Changes') {
            agent any
            steps {
                script {
                    def changes = sh(
                        script: 'git diff --name-only HEAD~1 HEAD || echo "frontend/"',
                        returnStdout: true
                    ).trim()

                    if (!changes.contains('frontend/')) {
                        currentBuild.result = 'NOT_BUILT'
                        error('No changes in frontend/ - skipping build')
                    }
                    echo "Frontend changes detected: proceeding with build"
                }
            }
        }

        /* -------------------------------------------------- */
        stage('Build Frontend') {
            agent {
                docker {
                    image 'node:20-alpine'
                    args '-u 1000:1000'  // Jenkins user와 동일한 UID/GID
                    reuseNode true
                }
            }
            steps {
                // env-fe secret file을 환경 변수로 로드
                withCredentials([file(credentialsId: 'env-fe', variable: 'ENV_FILE')]) {
                    dir('frontend/poom') {
                        sh '''
                            # env-fe 파일을 .env로 복사
                            cp $ENV_FILE .env

                            # 이전 빌드 결과물 정리 (Docker container 내부 실행)
                            rm -rf node_modules dist || true

                            # 환경 변수 확인 (디버깅용 - API KEY는 마스킹)
                            echo "=== Building with environment variables ==="
                            cat .env | grep -v "API_KEY" | grep -v "REST_API" || true

                            npm ci
                            npm run build
                        '''
                    }
                }
            }
        }

        /* -------------------------------------------------- */
        stage('Deploy to S3') {
            agent {
                docker {
                    image 'amazon/aws-cli:latest'
                    args '-u 1000:1000 --entrypoint=""'
                    reuseNode true
                }
            }
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                  credentialsId: 'aws-credentials']]) {
                    dir('frontend/poom') {
                        sh """
                            # S3 버킷에 빌드 파일 업로드
                            aws s3 sync dist/ s3://\${S3_PROD_BUCKET}/ \\
                                --region \${S3_REGION} \\
                                --delete \\
                                --cache-control 'public,max-age=31536000,immutable' \\
                                --exclude 'index.html'

                            # index.html은 캐시 없이 업로드
                            aws s3 cp dist/index.html s3://\${S3_PROD_BUCKET}/index.html \\
                                --region \${S3_REGION} \\
                                --cache-control 'public,max-age=0,must-revalidate'
                        """
                    }
                }
            }
        }

        /* -------------------------------------------------- */
        stage('Invalidate CloudFront') {
            agent {
                docker {
                    image 'amazon/aws-cli:latest'
                    args '-u 1000:1000 --entrypoint=""'
                    reuseNode true
                }
            }
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                  credentialsId: 'aws-credentials']]) {
                    sh """
                        # CloudFront 캐시 무효화
                        aws cloudfront create-invalidation \\
                            --distribution-id \${CLOUDFRONT_DISTRIBUTION_ID} \\
                            --paths '/*' \\
                            --region \${CLOUDFRONT_REGION}
                    """
                }
            }
        }
    }

    /* ------------------------------------------------------ */
    post {
        success {
            script {
                node {
                    echo '✅ Frontend S3 배포 성공'
                }
            }
        }
        failure {
            script {
                node {
                    echo '❌ Frontend S3 배포 실패 — 콘솔 로그 확인'
                }
            }
        }
        notBuilt {
            script {
                node {
                    echo '⏭️  Frontend 변경사항 없음 - 빌드 스킵'
                }
            }
        }
        always {
            script {
                node {
                    cleanWs(deleteDirs: true, disableDeferredWipeout: true)
                }
            }
        }
    }
}
