/*
 * Jenkins Pipeline - Frontend (S3 + CloudFront)
 * Triggers: Changes in frontend/ directory on dev branch
 */
pipeline {
    agent any

    environment {
        S3_BUCKET = 'topoom-s3-bucket'
        CLOUDFRONT_DISTRIBUTION_ID = 'E3ECTA5JTG17L5'
        AWS_REGION = 'ap-northeast-2'
    }

    options {
        skipDefaultCheckout()
        timestamps()
    }

    stages {

        /* -------------------------------------------------- */
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/dev']],
                    userRemoteConfigs: [[
                        url: 'https://lab.ssafy.com/s13-final/S13P31A706',
                        credentialsId: 'gitlab-jenkins-token'
                    ]]
                ])
            }
        }

        /* -------------------------------------------------- */
        stage('Check Changes') {
            steps {
                script {
                    def changes = sh(
                        script: 'git diff --name-only HEAD~1 HEAD || echo "frontend/"',
                        returnStdout: true
                    ).trim()

                    if (!changes.contains('frontend/')) {
                        currentBuild.result = 'NOT_BUILT'
                        error('No changes in frontend/ - skipping build')
                    }
                    echo "Frontend changes detected: proceeding with build"
                }
            }
        }

        /* -------------------------------------------------- */
        stage('Build Frontend') {
            steps {
                dir('frontend/poom') {
                    sh '''
                        npm ci
                        npm run build
                    '''
                }
            }
        }

        /* -------------------------------------------------- */
        stage('Deploy to S3') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                  credentialsId: 'aws-credentials']]) {
                    dir('frontend/poom') {
                        sh """
                            # S3 버킷에 빌드 파일 업로드
                            aws s3 sync dist/ s3://\${S3_PROD_BUCKET}/ \\
                                --region \${AWS_PROD_REGION} \\
                                --delete \\
                                --cache-control 'public,max-age=31536000,immutable' \\
                                --exclude 'index.html'

                            # index.html은 캐시 없이 업로드
                            aws s3 cp dist/index.html s3://\${S3_PROD_BUCKET}/index.html \\
                                --region \${AWS_PROD_REGION} \\
                                --cache-control 'public,max-age=0,must-revalidate'
                        """
                    }
                }
            }
        }

        /* -------------------------------------------------- */
        stage('Invalidate CloudFront') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                  credentialsId: 'aws-credentials']]) {
                    sh """
                        # CloudFront 캐시 무효화
                        aws cloudfront create-invalidation \\
                            --distribution-id \${CLOUDFRONT_DISTRIBUTION_ID} \\
                            --paths '/*' \\
                            --region \${AWS_PROD_REGION}
                    """
                }
            }
        }
    }

    /* ------------------------------------------------------ */
    post {
        success {
            echo '✅ Frontend S3 배포 성공'
        }
        failure {
            echo '❌ Frontend S3 배포 실패 — 콘솔 로그 확인'
        }
        notBuilt {
            echo '⏭️  Frontend 변경사항 없음 - 빌드 스킵'
        }
        always {
            cleanWs(deleteDirs: true, disableDeferredWipeout: true)
        }
    }
}
